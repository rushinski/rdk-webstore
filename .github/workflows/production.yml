name: Production CI

on:
  push:
    tags:
      - "v*.*.*"   # Example: v1.0.0, v2.3.5

jobs:
  production-build:
    runs-on: ubuntu-latest
    environment: production

    env:
      # Repo-level secrets
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

      # Production environment secrets (GH Environment: production)
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

      SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}

      STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
      STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}

      UPSTASH_REDIS_REST_URL: ${{ secrets.UPSTASH_REDIS_REST_URL }}
      UPSTASH_REDIS_REST_TOKEN: ${{ secrets.UPSTASH_REDIS_REST_TOKEN }}

      SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
      POSTHOG_API_KEY: ${{ secrets.POSTHOG_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install Dependencies
        run: npm ci

      - name: CI Env Validation (Zod)
        run: npm run ci-env:check

      - name: Env Variable Case Enforcement
        run: npm run check:env-case
      
      - name: File Case Enforcement
        run: npm run check:file-case

      - name: Lint
        run: npm run lint

      - name: Typecheck
        run: npm run typecheck

      - name: Unit Tests
        run: npm test -- --ci

      - name: Build
        run: npm run build

      # Safety: Validate DB migrations BEFORE running them
      - name: Schema Lint / Dry Run
        run: npx supabase db lint --project-ref $SUPABASE_PROJECT_ID

      # Apply prod migrations safely
      - name: Apply Migrations to Production
        run: npx supabase db push --project-ref $SUPABASE_PROJECT_ID --db-url $SUPABASE_DB_URL

      # Deploy to Production on Vercel
      - name: Deploy to Vercel (Production)
        run: npx vercel deploy --prod --token $VERCEL_TOKEN --yes --prebuilt

      # Optional: run in-production test checks after deployment
      - name: Run E2E Tests Against Production
        run: npm run test:e2e:prod

      - name: Run RLS Tests Against Production
        run: npm run test:rls:prod
