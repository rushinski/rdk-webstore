name: Staging CI

on:
  push:
    branches:
      - staging

jobs:
  validate-and-deploy:
    runs-on: ubuntu-latest
    environment: staging

    services:
      # Local PostgreSQL for migration validation
      supabase-db:
        image: public.ecr.aws/supabase/postgres:17.6.1.043
        ports:
          - 5432:5432
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      # Vercel
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }} 
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_STAGING_PROJECT_ID }}

      # Supabase
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY }}
      SUPABASE_SECRET_KEY: ${{ secrets.SUPABASE_SECRET_KEY }}
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}

      # Stripe
      NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}
      STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
      STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}

      # Shippo
      SHIPPO_API_TOKEN: ${{ secrets.SHIPPO_API_TOKEN }}
      SHIPPO_WEBHOOK_TOKEN: ${{ secrets.SHIPPO_WEBHOOK_TOKEN }}

      # Upstash Redis
      UPSTASH_REDIS_REST_URL: ${{ secrets.UPSTASH_REDIS_REST_URL }}
      UPSTASH_REDIS_REST_TOKEN: ${{ secrets.UPSTASH_REDIS_REST_TOKEN }}

      # Auth
      ADMIN_SESSION_SECRET: ${{ secrets.ADMIN_SESSION_SECRET }}
      ORDER_ACCESS_TOKEN_SECRET: ${{ secrets.ORDER_ACCESS_TOKEN_SECRET }}

      # Google OAuth
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}

      # AWS SES
      SES_SMTP_HOST: ${{ secrets.SES_SMTP_HOST }}
      SES_SMTP_USER: ${{ secrets.SES_SMTP_USER }}
      SES_SMTP_PASS: ${{ secrets.SES_SMTP_PASS }}
      SES_FROM_EMAIL: ${{ secrets.SES_FROM_EMAIL }}
      SES_FROM_NAME: ${{ secrets.SES_FROM_NAME }}
      SUPPORT_INBOX_EMAIL: ${{ secrets.SUPPORT_INBOX_EMAIL }}

      # AWS
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      # Public Config (can use variables instead of secrets)
      NEXT_PUBLIC_SITE_URL: ${{ vars.NEXT_PUBLIC_SITE_URL || 'https://rdk-staging.vercel.app' }}
      NEXT_PUBLIC_GUEST_CHECKOUT_ENABLED: ${{ vars.NEXT_PUBLIC_GUEST_CHECKOUT_ENABLED || 'true' }}

      # Local DB for validation
      LOCAL_SUPABASE_DB_URL: "postgresql://postgres:postgres@localhost:5432/postgres"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install Dependencies
        run: npm ci

      # Database Migration Validation
      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1

      - name: Validate Migrations Locally
        run: |
          # Apply migrations to local DB to verify they work
          supabase db push --db-url "$LOCAL_SUPABASE_DB_URL"
          # Lint the schema for common issues
          supabase db lint --db-url "$LOCAL_SUPABASE_DB_URL"

      # Code Quality
      - name: Lint
        run: npm run lint

      - name: Typecheck
        run: npm run typecheck

      # Build (validates env vars and Next.js config)
      - name: Build
        run: npm run build

      # Apply Migrations to Staging Database
      - name: Push Migrations to Staging
        run: supabase db push --db-url "$SUPABASE_DB_URL"

      # Seed the Staging Database
      - name: Seed Staging Database
        run: |
          echo "Seeding database..."
          psql "$SUPABASE_DB_URL" -f supabase/seed.sql
          echo "Database seeded successfully"

      # Deploy to Vercel
      - name: Install Vercel CLI
        run: npm i -g vercel

      - name: Pull Vercel Environment
        run: |
          echo "Pulling Vercel environment configuration..."
          vercel pull --yes --environment=production --token=$VERCEL_TOKEN
          echo "Environment pulled successfully"

      - name: Build Production Bundle
        run: |
          echo "Building production bundle for staging environment..."
          vercel build --prod --token=$VERCEL_TOKEN
          echo "Bundle built successfully"

      - name: Deploy to Staging
        id: deploy
        run: |
          echo "Deploying to staging..."
          DEPLOYMENT_URL=$(vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN)
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "Deployed to: $DEPLOYMENT_URL"

      # Basic Health Check
      - name: Health Check
        run: |
          sleep 10  # Give deployment a moment to become available
          curl -f "https://rdk-staging.vercel.app/api/healthz" || echo "Health check endpoint not found (optional)"